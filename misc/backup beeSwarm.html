<!DOCTYPE html>
<html>
<head>
  <title>Beeswarm Chart</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.blue_grey-amber.min.css" />
  <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
  <script src="lodash.js"></script>
  <style>
    button {
      margin:0 auto;
      display:block;
    }
  </style>
</head>

<body>
<nav>
  <div class="logo">
    <h4><a href="../Homepage.html">STRATAVIS</h4>
  </div>
  <ul class="nav-links">
    <li>
      <a href="../Homepage.html">Home</a>
    </li>
    <li>
      <a href="../gui/About.html">About</a>
    </li>
    <li>
      <a href="../gui/Dashboard.html">Dashboard</a>
    </li>
    <li>
      <a href="#">Contact Us</a>
    </li>
  </ul>

  <div class="burger">
    <div class="line1"></div>
    <div class="line2"></div>
    <div class="line3"></div>
  </div>
</nav>

<div id="particles-js">
  <script src="../js/particles.js"></script>
  <script src="../js/app.js"></script>
</div>

<div class="beeSwarm-background">
  <div class="centered" style="padding-top: 25px">

    <div class="measure-group" data-toggle="buttons-radio">
      <button type="button" class="measure mdl-button mdl-js-button mdl-button--raised mdl-button--colored" value="total">Total</button>
      <button type="button" class="measure mdl-button mdl-js-button mdl-button--raised mdl-button--colored" value="perCapita">Per Capita</button>
    </div>
    <div class="scale-group" data-toggle="buttons-radio">
      <button type="button" class="scale mdl-button mdl-js-button mdl-button--raised mdl-button--colored" value="scaleLinear">Linear Scale</button>
      <button type="button" class="scale mdl-button mdl-js-button mdl-button--raised mdl-button--colored" value="scaleLog">Log Scale</button>
    </div>
  </div>

  <div id="svganchor" class="graph centered">
  </div>

  <div id="checkboxes" class="centered">
    <span style="position:relative; top: 3px">Toggle Continents:&nbsp;&nbsp;</span>
    <label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect">
      <input type="checkbox" value="africa" class="mdl-checkbox__input continent" checked="">Africa
      <span class="mdl-checkbox__label" id="africaColor" style="font-size: 20px; color: #1976D2;">&#9679;&nbsp;&nbsp;</span>
    </label>
    <label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect">
      <input type="checkbox" value="northAmerica" class="mdl-checkbox__input continent" checked="">North America
      <span class="mdl-checkbox__label" id="northAmericaColor" style="font-size: 20px; color: #388E3C;">&#9679;&nbsp;&nbsp;</span>
    </label>
    <label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect">
      <input type="checkbox" value="southAmerica" class="mdl-checkbox__input continent" checked="">South America
      <span class="mdl-checkbox__label" id="southAmericaColor" style="font-size: 20px; color: #E64A19;">&#9679;&nbsp;&nbsp;</span>
    </label>
    <label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect">
      <input type="checkbox" value="asia" class="mdl-checkbox__input continent" checked="">Asia
      <span class="mdl-checkbox__label" id="asiaColor" style="font-size: 20px; color: #D81B60;">&#9679;&nbsp;&nbsp;</span>
    </label>
    <label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect">
      <input type="checkbox" value="europe" class="mdl-checkbox__input continent" checked="">Europe
      <span class="mdl-checkbox__label" id="europeColor" style="font-size: 20px; color: #FBC02D;">&#9679;&nbsp;&nbsp;</span>
    </label>
    <label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect">
      <input type="checkbox" value="oceania" class="mdl-checkbox__input continent" checked="">Oceania
      <span class="mdl-checkbox__label" id="oceaniaColor" style="font-size: 20px; color: #455A64;">&#9679;&nbsp;&nbsp;</span>
    </label>
  </div>

  <script>
    let height = 400;
    let width = 1000;
    let margin = ({top: 0, right: 40, bottom: 50, left:40 });

    let Scales = {
      lin: "scaleLinear",
      log: "scaleLog"
    };

    let Count = {
      total: "total",
      perCap: "perCapita"
    };

    let Legend= {
      total:"Total Deaths",
      perCap:"Per Capita "
    };

    let chartState= {}

    chartState.measure = Count.total;
    chartState.scale = Scales.lin;
    chartState.legend = Legend.total;

    /**
     * Import data
     * */

    let dataRow;
    let storageData;
    let storageColumn;
    let sampleColumn;
    let stringColumn;
    let deleteData;
    let xValue;
    let swarmCategories;

    storageData= sessionStorage.getItem('originalData');
    storageColumn = sessionStorage.getItem('columnsJson');
    storageCategories = sessionStorage.getItem('categories');



    deleteData = JSON.parse(storageData);
    deleteData.forEach(deleteData => {
      for (let key in deleteData) {
        if (Number(deleteData[key]))
          delete deleteData[key]

      };
    });

    stringColumn = Object.keys(deleteData[0]);

    sampleColumn = JSON.parse(storageColumn);

    sampleColumn.forEach(data => {
      for(let keys in data){
        _.pullAll(sampleColumn,stringColumn);
      }
    });

    dataRow  = JSON.parse(storageData);
    dataRow.forEach(data => {
      for (let key in data) {
        if (Number(data[key]))
          data[key] = +data[key];

      };
    });



    let colors = d3.scaleOrdinal()
      .domain(sampleColumn)
      .range(d3.schemeCategory10);

    d3.select("#asiaColour").style("color",colors("asia"));
    d3.select("#africaColor").style("color",colors("africa"));
    d3.select("#northAmericaColor").style("color",colors("northAmerica"));
    d3.select("#southAmericaColor").style("color",colors("southAmerica"));
    d3.select("europeColor").style("color",colors("europe"));
    d3.select("oceaniaColor").style("color",colors("oceania"));

    let svg = d3.select("#svganchor")
      .append("svg")
      .attr("width",width)
      .attr("height",height);

    let xScale = d3.scaleLinear()
      .range([margin.left, width - margin.right]);

    svg.append("g")
      .attr("class","x axis")
      .attr("transform","translate(0," + (height - margin.bottom) + ")");

    //Create line  that connect node and point on xaxis

    let xLine = svg.append("line")
      .attr("stroke","rgb(96,125,139)")
      .attr("stroke-dasharray","1,2");

    let tooltip = d3.select("#svganchor").append("div")
      .attr("class","tooltip")
      .style("opacity",0);


    xValue = sampleColumn[0];
    console.log(xValue);

    function render(data) {

      let dataSet = data;

      xScale.domain(d3.extent(data,function(d){
        return +d.xValue;
      }));

      redraw();

      d3.selectAll(".measure").on("click", function () {

        let thisClicked = this.value;
        chartState.measure = thisClicked;

        if (thisClicked === Count.total) {
          chartState.legend = Legend.total;
        }

        if (thisClicked === Count.perCap) {
          chartState.legend = Legend.perCap
        }

        redraw();

      });

      d3.selectAll(".scale").on("click", function () {
        chartState.scale = this.value;
        redraw(chartState.measure);
      });

      d3.selectAll("input").on("change", filter);

      function redraw() {

        if (chartState.scale === Scales.lin) {
          xScale = d3.scaleLinear().range([margin.left, width - margin.right])
        }

        if (chartState.scale === Scales.log) {
          xScale = d3.scaleLog().range([margin.left, width - margin.right])
        }

        xScale.domain(d3.extent(dataSet, function (d) {
          return +d[chartState.measure];
        }));

        let xAxis;

        if (chartState.measure === Count.perCap) {
          xAxis = d3.axisBottom(xScale)
            .ticks(10, ".1f")
            .tickSizeOuter(0);
        } else {
          xAxis = d3.axisBottom(xScale)
            .ticks(10, ".1s")
            .tickSizeOuter(0);
        }

        d3.transition(svg).select(".x.axis")
          .transition()
          .duration(1000)
          .call(xAxis);

        let simulation = d3.forceSimulation(dataSet)
          .force("x", d3.forceX(function (d) {
            return xScale(+d[chartState.measure]);
          }).strength(2))
          .force("y", d3.forceY((height / 2) - margin.bottom / 2))
          .force("collide", d3.forceCollide(9))
          .stop();

        for (let i = 0; i < dataSet.length; i++) {
          simulation.tick(10);
        }

        let countriesCircles = svg.selectAll(".countries")
          .data(dataSet, function (d) {
            return d.country
          });

        countriesCircles.exit()
          .transition()
          .duration(1000)
          .attr("cx", 0)
          .attr("cy", (height / 2) - margin.bottom / 2)
          .remove();

        countriesCircles.enter()
          .append("circle")
          .attr("class", "countries")
          .attr("cx", 0)
          .attr("cy", (height / 2) - margin.bottom / 2)
          .attr("r", 6)
          .attr("fill", function (d) {
            return colors(d.continent)
          })
          .merge(countriesCircles)
          .transition()
          .duration(2000)
          .attr("cx", function (d) {
            return d.x;
          })
          .attr("cy", function (d) {
            return d.y;
          });

        // Show tooltip when hovering over circle (data for respective country)
        d3.selectAll(".countries").on("mousemove", function (d) {
          tooltip.html(`Country: <strong>${d.country}</strong><br>
                          ${chartState.legend.slice(0, chartState.legend.indexOf(","))}:
                          <strong>${d3.format(",")(d[chartState.measure])}</strong>
                          ${chartState.legend.slice(chartState.legend.lastIndexOf(" "))}`)
            .style('top', d3.event.pageY - 12 + 'px')
            .style('left', d3.event.pageX + 25 + 'px')
            .style("opacity", 0.9);

          xLine.attr("x1", d3.select(this).attr("cx"))
            .attr("y1", d3.select(this).attr("cy"))
            .attr("y2", (height - margin.bottom))
            .attr("x2", d3.select(this).attr("cx"))
            .attr("opacity", 1);

        }).on("mouseout", function (_) {
          tooltip.style("opacity", 0);
          xLine.attr("opacity", 0);
        });

      }

      function filter() {

        function getCheckedBoxes(checkboxName) {

          let checkboxes = d3.selectAll(checkboxName).nodes();
          let checkboxesChecked = [];
          for (let i = 0; i < checkboxes.length; i++) {
            if (checkboxes[i].checked) {
              checkboxesChecked.push(checkboxes[i].defaultValue);
            }
          }
          return checkboxesChecked.length > 0 ? checkboxesChecked : null;
        }

        let checkedBoxes = getCheckedBoxes(".continent");

        let newData = [];

        if (checkedBoxes == null) {
          dataSet = newData;
          redraw();
          return;
        }
        for (let i = 0; i < checkedBoxes.length; i++) {
          let newArray = data.filter(function (d) {
            return d.continent === checkedBoxes[i];
          });
          Array.prototype.push.apply(newData, newArray);
        }

        dataSet = newData;
        redraw();

      }
    }
    render(dataRow);



  </script>

</div>
</body>

<script src = "https://d3js.org/d3.v5.min.js"></script>
<script src = "../js/beeswarm.js"></script>

</html>
